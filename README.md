# ニキシー管風デジタル時計 🕐

ESP32-C3 と 6 個の ST7789 TFT ディスプレイを使用した WebUI 対応ニキシー管風デジタル時計

https://github.com/user-attachments/assets/07f6658b-fd32-4206-b1ce-a6842fe732e1

また、issueに使用しているところの動画(容量が重いので注意)

https://github.com/SplatoonSR/nikisi-ESP-IPS/issues/5#issue-3310970903

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Platform](https://img.shields.io/badge/platform-ESP32--C3-orange.svg)
![Build](https://img.shields.io/badge/build-PlatformIO-green.svg)
![Version](https://img.shields.io/badge/version-3.0-red.svg)

## 📋 プロジェクト概要

このプロジェクトは、ESP32-C3 マイコンと 6 個の ST7789 TFT ディスプレイを使用して、ニキシー管風のデジタル時計を作成します。**自動 WiFi 設定機能**でどこでも簡単に使用でき、**3 つの画像セット対応**でより多彩なカスタマイズが可能な高機能ニキシー管時計です。

## ✨ 主な機能

### 🎯 基本機能

- **6 ディスプレイ表示**: 時:分:秒の 6 桁をそれぞれ独立したディスプレイで表示
- **ニキシー管風デザイン**: レトロな雰囲気のニキシー管画像を使用
- **NTP 時刻同期**: NTP サーバーから自動で正確な時刻を取得（JST 対応）
- **省電力設計**: 変更があった桁のみ更新する効率的な表示システム

### 🌐 革新的 WiFi 機能

- **🔧 スマート初期設定**: WiFi 未設定時は自動でアクセスポイントモードに移行
- **📱 スマホ設定対応**: スマートフォンから WiFi 設定を簡単入力
- **🔄 自動フォールバック**: 接続失敗時の 3 段階自動復旧システム
- **📡 QR コード表示**: 起動時に接続情報を 5 秒間 QR コードで表示（ポータブル対応）
- **💾 設定永続化**: 一度設定すれば場所を移動しても自動接続

### 🎨 高度なカスタマイズ機能

- **3 セット画像管理**: 最大 30 枚（3 セット ×10 数字）のカスタム画像を保存可能
- **ワンタッチ切り替え**: WebUI から瞬時にセット切り替え
- **RGB565 自動変換**: JPEG/PNG 等の一般画像を自動変換
- **メモリ最適化**: 動的読み込みによるメモリ効率化
- **設定完全保存**: 電源 OFF 後も全設定とカスタム画像を完全保持

### 🔧 技術的特徴

- **SPIFFS 活用**: 設定とカスタム画像の永続化ストレージ
- **JSON 設定管理**: 構造化された設定ファイル（`settings.json`）
- **リアルタイム監視**: ストレージ使用量とシステム状態の監視
- **堅牢性**: エラー時の自動復旧とフォールバック機能

## 🚀 クイックスタート

### 📱 初回起動（WiFi 設定なし）

1. **ESP32 に書き込み**: プログラムをアップロード
2. **アクセスポイント起動**: 自動的に「NixieClock-Setup」が起動
3. **スマホ接続**: WiFi 一覧から「NixieClock-Setup」に接続（パスワード: 12345678）
4. **自動設定画面**: ブラウザが自動で設定画面を開く
5. **WiFi 設定入力**: 使用する WiFi の SSID とパスワードを入力
6. **自動再起動**: 設定完了後、デバイスが自動で再起動し通常動作開始

### ⚡ 通常起動（WiFi 設定済み）

1. **電源 ON**: デバイスの電源を入れる
2. **WiFi 自動接続**: 保存された WiFi 設定で自動接続
3. **QR コード表示**: 接続情報を 5 秒間 QR コードで表示（IP アドレス確認用）
4. **時計動作開始**: NTP 時刻同期後、ニキシー管時計として動作

### 🌐 WebUI アクセス

- **通常時**: `http://[デバイスのIPアドレス]`
- **設定時**: `http://192.168.4.1` （AP モード時）

## 💻 開発環境セットアップ

### 🛠️ 必要なツール

- **PlatformIO IDE**: VS Code + PlatformIO 拡張機能
- **Arduino Framework**: ESP32-C3 サポート

### 📦 必要ライブラリ（自動インストール）

```ini
[lib_deps]
moononournation/GFX Library for Arduino@^1.4.7
bblanchon/ArduinoJson@^7.4.2
ricmoo/QRCode@^0.0.1
```

### 🔧 ビルド・アップロード手順

```bash
# プロジェクトをクローン
git clone https://github.com/SplatoonSR/nikisi-ESP-IPS.git
cd nikisi-ESP-IPS/nikisiLOCAL

# WebファイルをSPIFFSにアップロード（重要！）
pio run -t uploadfs

# ESP32-C3にプログラムをアップロード
pio run -t upload

# シリアルモニターで動作確認
pio device monitor
```

## ⚙️ WiFi 設定方式（3 種類対応）

### 🥇 推奨：自動設定方式

デバイス起動時に WiFi 設定がない場合、自動で AP モードに移行し、スマートフォンから簡単設定

### 🥈 手動設定方式（上級者向け）

```cpp
// nikisiLOCAL/src/config.h で直接設定
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
const char* ntpServer = "ntp.nict.jp";
```

### 🥉 フォールバック方式

保存設定 → config.h 設定 → AP モード の順で自動試行

## �️ ハードウェア構成

### 📦 必要な部品

- **ESP32-C3 DevKit-M-1** × 1
- **ST7789 TFT ディスプレイ (170×320)** × 6
- **JST XH コネクタ 8 ピン オスとメス** × 6
- **ジャンパーワイヤー** 適量
- **ブレッドボード** または カスタム PCB

### 📺 ディスプレイ配置

```
┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ディスプレイ6 │ディスプレイ5 │ディスプレイ4 │ディスプレイ3 │ディスプレイ2  │ディスプレイ1 │
│   時十の位   │   時一の位  │   分十の位   │   分一の位   │   秒十の位   │   秒一の位   │
│  (GPIO21)   │  (GPIO20)   │  (GPIO10)   │  (GPIO9)    │  (GPIO8)    │  (GPIO7)    │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
          12:34:56 の表示例
```

### 🔌 ESP32-C3 ピン配置

| 機能 | ESP32-C3 Pin | 接続先                          | 説明                             |
| ---- | ------------ | ------------------------------- | -------------------------------- |
| MOSI | GPIO6        | 全ディスプレイの SDA            | SPI データライン（共通）         |
| SCLK | GPIO4        | 全ディスプレイの SCL            | SPI クロックライン（共通）       |
| DC   | GPIO2        | 全ディスプレイの DC             | データ/コマンド切り替え（共通）  |
| RST  | 10kΩ→VCC     | 全ディスプレイの RST            | リセット（共通、プルアップ必須） |
| CS1  | GPIO7        | ディスプレイ 1 の CS (秒一の位) | チップセレクト（個別制御）       |
| CS2  | GPIO8        | ディスプレイ 2 の CS (秒十の位) | チップセレクト（個別制御）       |
| CS3  | GPIO9        | ディスプレイ 3 の CS (分一の位) | チップセレクト（個別制御）       |
| CS4  | GPIO10       | ディスプレイ 4 の CS (分十の位) | チップセレクト（個別制御）       |
| CS5  | GPIO20       | ディスプレイ 5 の CS (時一の位) | チップセレクト（個別制御）       |
| CS6  | GPIO21       | ディスプレイ 6 の CS (時十の位) | チップセレクト（個別制御）       |

### ⚠️ 重要な注意事項

- **GPIO20, 21 は ESP32-C3 で不安定な場合があります（GPIO5, 3 への変更を推奨）**
- **全ディスプレイは 3.3V or 5V 電源で動作します**
- **SPI 通信のため、MOSI/SCLK/DC は全ディスプレイで共通接続**

## 🎨 カスタム画像機能

### � 3 セット画像システム

- **セット 0, 1, 2**: 各セット 10 枚（数字 0-9）、合計 30 枚まで保存可能
- **リアルタイム切り替え**: WebUI からワンクリックでセット変更
- **個別管理**: セットごとの削除・追加が可能

### 🖼️ 対応画像仕様

| 項目               | 仕様              | 説明                           |
| ------------------ | ----------------- | ------------------------------ |
| **最大解像度**     | 70×134 ピクセル   | ニキシー管デフォルト画像サイズ |
| **ファイルサイズ** | 512KB 以下        | 一般画像ファイル制限           |
| **RGB565 サイズ**  | 18,760 バイト     | 変換後の固定サイズ             |
| **対応形式**       | JPEG, PNG, GIF 等 | ブラウザサポート形式           |
| **縦横比**         | 自動保持          | リサイズ時に縦横比維持         |
| **背景**           | 黒色              | 余白部分は黒で塗りつぶし       |

### � アップロード手順

1. **WebUI アクセス**: デバイスの IP アドレスにブラウザでアクセス
2. **セット選択**: 使用するセット（0-2）を選択
3. **数字選択**: カスタマイズしたい数字（0-9）を選択
4. **画像選択**: ローカルファイルから画像を選択
5. **自動変換**: 70×134 ピクセル、RGB565 フォーマットに自動変換
6. **アップロード**: 「アップロード」ボタンで送信完了

### � 管理機能

- **🔄 セット切り替え**: 3 つのセット間を瞬時に切り替え
- **🗑️ セット削除**: 指定セットの全画像を一括削除
- **� 設定保存**: 使用セットと画像設定を自動保存
- **📊 容量監視**: SPIFFS 使用量をリアルタイム表示

## 🌐 API リファレンス

| エンドポイント    | メソッド | 機能                                 | レスポンス例                                  |
| ----------------- | -------- | ------------------------------------ | --------------------------------------------- |
| `/`               | GET      | WebUI ページ表示（通常/AP 自動切替） | HTML                                          |
| `/wifi-config`    | POST     | WiFi 設定保存・再起動                | HTML（成功画面）                              |
| `/upload`         | POST     | カスタム画像アップロード             | `{"success":true}`                            |
| `/api/time`       | GET      | 現在時刻取得                         | `{"time":"12:34:56","initialized":true}`      |
| `/api/status`     | GET      | システム状態取得                     | `{"useCustomImages":true, "freeHeap":180000}` |
| `/api/wifi-info`  | GET      | WiFi 接続情報取得                    | `{"mode":"STA","ip":"192.168.1.100"}`         |
| `/api/set-switch` | POST     | 画像セット切り替え                   | `{"success":true,"currentSet":1}`             |
| `/api/get-sets`   | GET      | 利用可能セット一覧取得               | `{"currentSet":1,"sets":[...]}`               |
| `/api/delete-set` | POST     | 指定セット削除                       | `{"success":true,"message":"Deleted..."}`     |
| `/api/reset`      | POST     | デフォルト画像切り替え（画像保持）   | `{"success":true,"message":"...preserved"}`   |
| `/api/delete-all` | POST     | 全カスタム画像削除                   | `{"success":true,"message":"Deleted N ..."}`  |
| `/api/use-custom` | POST     | カスタム画像使用開始                 | `{"success":true}`                            |
| `/api/refresh`    | POST     | 画面強制更新                         | `{"success":true}`                            |

## 🔧 トラブルシューティング

### ❗ よくある問題と解決方法

#### 1. 🌐 WiFi 接続に関する問題

**問題**: AP モードから抜け出せない

- **原因**: 保存された WiFi 設定が無効
- **解決**: シリアルモニターで設定状況を確認、必要に応じて再設定

**問題**: 設定後も AP モードのまま

- **原因**: パスワードが間違っている、WiFi 信号が弱い
- **解決**: 正確な認証情報を再入力、デバイス位置を調整

#### 2. �️ ディスプレイ表示の問題

**問題**: 一部ディスプレイにノイズ

- **原因**: 電源供給不足、配線品質
- **解決**: 3.3V 電源容量確認、配線の短縮・品質向上

**問題**: GPIO20/21 のディスプレイが不安定

- **原因**: ESP32-C3 特有の問題
- **解決**: GPIO5, 3 への変更を推奨

#### 3. 💾 ストレージ・画像の問題

**問題**: カスタム画像がアップロードできない

- **原因**: SPIFFS 容量不足、ファイルサイズ超過
- **解決**: 不要セットを削除、画像サイズを確認

**問題**: 設定が保存されない

- **原因**: SPIFFS 初期化失敗
- **解決**: シリアルモニターで SPIFFS 状態を確認

#### 4. 🕐 時刻同期の問題

**問題**: 時刻が正確でない

- **原因**: NTP 同期失敗、タイムゾーン設定
- **解決**: インターネット接続確認、NTP サーバー変更

## 📊 パフォーマンス・容量情報

### システム仕様

| 項目               | 仕様          | 実測値               |
| ------------------ | ------------- | -------------------- |
| **メモリ使用量**   | 約 200KB      | 動的変動             |
| **1 画像サイズ**   | 18,760 バイト | 70×134×2 バイト      |
| **最大画像数**     | 30 枚         | 3 セット ×10 数字    |
| **SPIFFS 総容量**  | 約 1.3MB      | 設定+HTML 含む       |
| **WebUI 応答時間** | < 200ms       | ローカルネットワーク |
| **時計更新頻度**   | 1 秒間隔      | 変更時のみ更新       |

### 容量計算

- **1 セット**: 187,600 バイト（18,760 × 10 枚）
- **3 セット満載**: 562,800 バイト（約 550KB）
- **残り容量**: 設定ファイル・WebUI 分を含めて約 700KB 利用可能

## 📁 プロジェクト構成

```
nikisi-ESP-IPS/
├── 📄 README.md               # このファイル（プロジェクト概要・完全版ドキュメント）
└── 📂 nikisiLOCAL/            # メインプロジェクトディレクトリ
    ├── 📄 platformio.ini      # PlatformIO設定ファイル
    ├── 📂 src/                # ソースコードディレクトリ
    │   ├── 🎯 main.cpp        # メインプログラム（ESP32制御・WebServer・WiFi管理）
    │   ├── ⚙️ config.h        # WiFi設定（手動設定用・gitignore対象）
    │   ├── 📋 config.h.example # WiFi設定テンプレート
    │   ├── 🎨 image_data.h    # デフォルトニキシー管画像データ
    │   ├── 📡 qr_display.h    # QRコード表示機能ヘッダー
    │   └── 📡 qr_display.cpp  # QRコード表示機能実装
    ├── 📂 data/               # SPIFFS用Webファイル
    │   ├── 🌐 index.html      # WebUI（3セット対応・画像アップロード）
    │   ├── � index_japanese.html # 日本語版WebUI
    │   ├── 🌐 index_premium.html  # プレミアム版WebUI
    │   ├── 🌐 index_simple.html   # シンプル版WebUI
    │   └── 🎨 style.css       # WebUI用CSS
    ├── 📂 include/            # ヘッダーファイル（予約）
    ├── 📂 lib/                # プライベートライブラリ（予約）
    ├── 📂 test/               # テストファイル（予約）
    └── 📄 .gitignore          # Git除外設定
```

### 🔧 重要ファイル詳細

#### `nikisiLOCAL/src/main.cpp`

- **機能**: ESP32 メインプログラム
- **主要処理**:
  - ディスプレイ制御（6 画面同時）
  - WiFi 接続・NTP 時刻同期
  - Web サーバー運用
  - カスタム画像管理（SPIFFS）
  - メモリ最適化処理

#### `nikisiLOCAL/data/index.html`

- **機能**: WebUI インターフェース
- **主要機能**:
  - リアルタイム時刻表示
  - カスタム画像アップロード（0-9 各数字）
  - RGB565 自動変換
  - 縦横比保持リサイズ
  - システム状態監視

## 🌐 API エンドポイント

| エンドポイント    | メソッド | 機能                     | レスポンス例                                  |
| ----------------- | -------- | ------------------------ | --------------------------------------------- |
| `/`               | GET      | WebUI ページ表示         | HTML                                          |
| `/upload`         | POST     | カスタム画像アップロード | `{"success":true}`                            |
| `/api/time`       | GET      | 現在時刻取得             | `{"time":"12:34:56"}`                         |
| `/api/status`     | GET      | システム状態取得         | `{"useCustomImages":true, "freeHeap":180000}` |
| `/api/reset`      | POST     | デフォルト画像リセット   | `{"success":true}`                            |
| `/api/use-custom` | POST     | カスタム画像使用開始     | `{"success":true}`                            |
| `/api/refresh`    | POST     | 画面強制更新             | `{"success":true}`                            |

## 🔧 トラブルシューティング

### ❗ よくある問題と解決方法

#### 1. 🖥️ ディスプレイにノイズが表示される

**原因**: 電源供給不足、信号品質劣化
**解決方法**:

- 3.3V 電源の容量を確認（全ディスプレイで約 1A 必要）
- ジャンパーワイヤーを短くする
- 共通配線（MOSI/SCLK/DC）の品質を向上

#### 2. 🌐 WiFi に接続できない

**原因**: WiFi 設定エラー、信号強度不足
**解決方法**:

```cpp
// nikisiLOCAL/src/config.hの設定を確認
const char* ssid = "正確なSSID";
const char* password = "正確なパスワード";
```

- シリアルモニターで WiFi 接続ログを確認
- 2.4GHz 帯の WiFi を使用（5GHz 帯不可）

#### 3. 📱 WebUI にアクセスできない

**原因**: IP アドレス不明、ファイアウォールブロック
**解決方法**:

- シリアルモニターで IP アドレスを確認
- `pio run -t uploadfs`で Web ファイルがアップロードされているか確認
- ファイアウォール設定を確認

#### 4. 💾 カスタム画像アップロードエラー

**原因**: ファイルサイズ、フォーマット、メモリ不足
**解決方法**:

- 画像ファイルサイズを 512KB 以下に
- RGB565 ファイルは正確に 18,760 バイト
- ESP32 を再起動してメモリをクリア

#### 5. ⚡ 一部のディスプレイが表示されない

**原因**: GPIO20/21 の不安定性（ESP32-C3 特有）
**解決方法**:

- GPIO5, GPIO3 への変更を検討
- 配線の接触不良を確認
- 電源供給能力をチェック

#### 6. 🕐 時刻が正確でない

**原因**: NTP サーバー接続失敗、タイムゾーン設定
**解決方法**:

```cpp
// nikisiLOCAL/src/main.cppでタイムゾーン確認
configTime(9 * 3600, 0, ntpServer); // JST (UTC+9)
```

- インターネット接続を確認
- NTP サーバーの応答性をテスト

## 📊 パフォーマンス情報

| 項目              | 仕様     | 実測値        |
| ----------------- | -------- | ------------- |
| **メモリ使用量**  | 約 180KB | 動的変動      |
| **画像サイズ**    | 70×134px | 18,760 バイト |
| **応答時間**      | WebUI    | < 200ms       |
| **更新頻度**      | 時計表示 | 1 秒間隔      |
| **消費電力**      | 推定     | < 2W          |
| **WiFi 到達距離** | 一般的   | 10-30m        |

### 👨‍💻 作成者

**SplatoonSR**

- GitHub: [@SplatoonSR](https://github.com/SplatoonSR)
- Repository: [nikisi-ESP-IPS](https://github.com/SplatoonSR/nikisi-ESP-IPS)

## 📚 参考資料

### 📖 技術資料

- [ESP32-C3 Technical Reference Manual](https://www.espressif.com/sites/default/files/documentation/esp32-c3_technical_reference_manual_en.pdf)
- [Arduino_GFX_Library Documentation](https://github.com/moononournation/Arduino_GFX)
- [ST7789 Display Controller Datasheet](https://www.rhydolabz.com/documents/33/ST7789.pdf)

### 🛠️ 開発ツール

- [PlatformIO Documentation](https://docs.platformio.org/)
- [VS Code Extensions for PlatformIO](https://marketplace.visualstudio.com/items?itemName=platformio.platformio-ide)

---

## 📝 更新履歴

| バージョン | 日付       | 更新内容                                           |
| ---------- | ---------- | -------------------------------------------------- |
| v1.0       | 2025-08-12 | WiFi 革命機能・3 セット画像管理・QR コード表示追加 |

---

**🎯 プロジェクトゴール**: モダンな WebUI 技術とクラシックなニキシー管の美学を融合した、自分だけの時計を作りましょう！

## 🔍 API リファレンス

### WebAPI エンドポイント

| エンドポイント    | メソッド | 説明                 |
| ----------------- | -------- | -------------------- |
| `/`               | GET      | WebUI 表示           |
| `/upload`         | POST     | 画像アップロード     |
| `/api/time`       | GET      | 現在時刻取得         |
| `/api/status`     | GET      | システム状態取得     |
| `/api/reset`      | POST     | デフォルト画像に戻す |
| `/api/use-custom` | POST     | カスタム画像を使用   |
| `/api/refresh`    | POST     | 表示強制更新         |

### ステータス API レスポンス例

```json
{
  "useCustomImages": true,
  "customImages": [
    true,
    false,
    true,
    false,
    false,
    false,
    false,
    false,
    false,
    false
  ],
  "freeHeap": 234567
}
```

## 🎯 今後の拡張予定

### 計画中の機能

- [ ] **タイマー機能**: カウントダウンタイマー
- [ ] **アニメーション**: 数字切り替え時のエフェクト

### ハードウェア改良

- [ ] **PCB 設計**: 専用基板の作成
- [ ] **ケース設計**: 3D プリント対応

## 📄 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。詳細は [LICENSE](LICENSE) ファイルをご覧ください。

### プロジェクトライセンス

- ✅ 商用利用可能
- ✅ 改変・再配布可能
- ✅ プライベート利用可能
- ⚠️ ライセンス表示が必要

### 使用ライブラリとそのライセンス

このプロジェクトは以下のオープンソースライブラリを使用しています：

| ライブラリ                                                                            | バージョン | ライセンス   | 用途                          |
| ------------------------------------------------------------------------------------- | ---------- | ------------ | ----------------------------- |
| [GFX Library for Arduino](https://github.com/moononournation/Arduino_GFX)             | ^1.4.7     | BSD-3-Clause | ディスプレイ制御              |
| [ArduinoJson](https://github.com/bblanchon/ArduinoJson)                               | ^7.4.2     | MIT          | JSON 処理                     |
| [QRCode](https://github.com/ricmoo/QRCode)                                            | ^0.0.1     | MIT          | QR コード生成                 |
| [Adafruit GFX Library](https://github.com/adafruit/Adafruit-GFX-Library)              | ^1.12.1    | BSD          | グラフィックス基盤            |
| [Adafruit ST7735/ST7789 Library](https://github.com/adafruit/Adafruit-ST7735-Library) | ^1.11.0    | BSD          | ST7789 ディスプレイドライバー |

**ライセンス表示義務**：

- 本プロジェクトを使用・配布する際は、上記ライブラリのライセンス条項も併せて遵守してください
- 各ライブラリの詳細なライセンス内容は、それぞれの GitHub リポジトリをご確認ください

**第三者ライセンス情報**：
すべての依存ライブラリは、商用利用を含む自由な使用を許可していますが、それぞれのライセンス条項に従ってください。
詳細なライセンス情報は [THIRD-PARTY-LICENSES.md](THIRD-PARTY-LICENSES.md) をご覧ください

---

**楽しいニキシー管ライフを！** 🎉
