# Nixie Style Digital Clock 🕐

ESP32-C3 と 6 個の ST7789 TFT ディスプレイを使用したニキシー管風デジタル時計プロジェクト

## 📋 プロジェクト概要

このプロジェクトは、ESP32-C3 マイコンと 6 個の ST7789 TFT ディスプレイを使用して、ニキシー管風のデジタル時計を作成します。WiFi 経由で NTP サーバーから正確な時刻を取得し、HH:MM:SS 形式で表示します。さらに、WebUI を通じてカスタム画像をアップロードして、独自のニキシー管デザインにカスタマイズできます。

## ✨ 特徴

- **6 ディスプレイ表示**: 時:分:秒の 6 桁をそれぞれ独立したディスプレイで表示
- **ニキシー管風デザイン**: レトロな雰囲気のニキシー管画像を使用
- **カスタム画像アップロード**: WebUI から独自のニキシー管画像をアップロード可能
- **WiFi サーバー機能**: ESP32 を Web サーバーとして動作、リモート管理が可能
- **WiFi 時刻同期**: NTP サーバーから自動で正確な時刻を取得
- **省電力設計**: 変更があった桁のみ更新する効率的な表示更新
- **セキュア設定**: WiFi 認証情報は外部ファイルで管理
- **SPIFFS 使用**: HTML/CSS/JS ファイルを分離したプロフェッショナルな構成

## 🛠️ ハードウェア構成

### 必要な部品

- ESP32-C3 DevKit-M-1 × 1
- ST7789 TFT ディスプレイ (170×320) × 6
- 10kΩ 抵抗 × 1 (RST pin 用プルアップ)
- ジャンパーワイヤー
- ブレッドボード

### ディスプレイ配置

```
[ディスプレイ6] [ディスプレイ5] [ディスプレイ4] [ディスプレイ3] [ディスプレイ2] [ディスプレイ1]
    時十の位      時一の位      分十の位      分一の位      秒十の位      秒一の位
    (GPIO21)     (GPIO20)     (GPIO10)      (GPIO9)       (GPIO8)       (GPIO7)
```

## 🔌 配線図

### ESP32-C3 ピン配置

| 機能 | ESP32-C3 Pin | 接続先                                  |
| ---- | ------------ | --------------------------------------- |
| MOSI | GPIO6        | 全ディスプレイの SDA                    |
| SCLK | GPIO4        | 全ディスプレイの SCL                    |
| DC   | GPIO2        | 全ディスプレイの DC                     |
| RST  | -            | 全ディスプレイの RST + 10kΩ プルアップ  |
| CS1  | GPIO7        | ディスプレイ 1 の CS (秒一の位)         |
| CS2  | GPIO8        | ディスプレイ 2 の CS (秒十の位)         |
| DC   | GPIO2        | 全ディスプレイの DC                     |
| RST  | 10kΩ→VCC     | 全ディスプレイの RST (共通, プルアップ) |
| CS1  | GPIO7        | ディスプレイ 1 の CS (秒一の位)         |
| CS2  | GPIO8        | ディスプレイ 2 の CS (秒十の位)         |
| CS3  | GPIO9        | ディスプレイ 3 の CS (分一の位)         |
| CS4  | GPIO10       | ディスプレイ 4 の CS (分十の位)         |
| CS5  | GPIO20       | ディスプレイ 5 の CS (時一の位)         |
| CS6  | GPIO21       | ディスプレイ 6 の CS (時十の位)         |

### 重要な注意事項

⚠️ **RST pin は 10kΩ で VCC にプルアップしてください**  
⚠️ **GPIO20, 21 は ESP32-C3 で不安定な場合があります（GPIO5, 3 への変更を推奨）**

## 🌐 WebUI 機能

### Web サーバーアクセス

1. **IP アドレス確認**: シリアルモニタで ESP32 の IP アドレスを確認
2. **ブラウザアクセス**: `http://[ESP32のIPアドレス]`にアクセス
3. **リアルタイム表示**: 現在時刻が WebUI でリアルタイム表示

### カスタム画像アップロード機能

#### 📤 画像アップロード手順

1. **Web UI アクセス**: ESP32 の IP アドレスにブラウザでアクセス
2. **数字選択**: 0-9 の中からカスタマイズしたい数字を選択
3. **画像選択**: ローカルファイルから画像を選択
4. **自動変換**: 画像は自動的に 170×320 ピクセル、RGB565 フォーマットに変換
5. **アップロード実行**: 「アップロード」ボタンで送信

#### 🎨 対応画像仕様

- **最大解像度**: 170×320 ピクセル（ディスプレイ解像度）
- **ファイルサイズ**: 512KB 以下
- **対応形式**: JPEG, PNG, GIF 等（ブラウザサポート形式）
- **自動変換**: RGB565 フォーマットに自動変換

#### 🔄 画像切り替え機能

- **デフォルト画像**: 「デフォルト画像を使用」ボタンで元のニキシー管画像に戻す
- **カスタム画像**: 「カスタム画像を使用」ボタンでアップロード画像に切り替え
- **リアルタイム更新**: 切り替え時に時計表示が即座に反映

#### 📊 システム状態確認

- **アップロード状況**: 各数字のアップロード状態を表示
- **メモリ使用量**: ESP32 のメモリ使用状況を監視
- **デバッグ情報**: `/api/status`エンドポイントで詳細情報確認可能

## 💻 ソフトウェア設定

### 開発環境

- **PlatformIO IDE**: VS Code + PlatformIO 拡張機能
- **Arduino Framework**: ESP32-C3 サポート
- **Arduino_GFX Library**: v1.6.0

### 必要なライブラリ

```ini
[lib_deps]
moononournation/GFX Library for Arduino@^1.6.0
bblanchon/ArduinoJson@^6.21.3
```

### WiFi 設定

1. `src/config.h.example`を`src/config.h`にコピー
2. WiFi 認証情報を設定:

```cpp
// WiFi設定
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// NTP設定
const char* ntpServer = "ntp.nict.jp";
const int timeZone = 9; // JST (UTC+9)
```

## 🚀 ビルド・実行方法

### 1. 環境準備

```bash
# PlatformIOプロジェクトをクローン
git clone <repository_url>
cd nikisiLOCAL

# config.hを設定
cp src/config.h.example src/config.h
# エディタでconfig.hを編集してWiFi情報を入力
```

### 2. ビルド・アップロード

```bash
# ビルド
pio run

# データファイル（HTML/CSS）をSPIFFSにアップロード
pio run -t uploadfs

# ESP32-C3にプログラムをアップロード
pio run -t upload

# シリアルモニター（デバッグ情報確認）
pio device monitor
```

### 3. 初回起動

1. **シリアルモニタ確認**: WiFi 接続と IP アドレスを確認
2. **WebUI アクセス**: ブラウザで`http://[表示されたIPアドレス]`にアクセス
3. **動作確認**: 時計表示と WebUI が正常に動作することを確認

## 📁 ファイル構成

```
nikisiLOCAL/
├── src/
│   ├── main.cpp              # メインプログラム
│   ├── config.h              # WiFi設定 (gitignore対象)
│   ├── config.h.example      # WiFi設定テンプレート
│   └── image_data.h          # デフォルトニキシー管画像データ
├── data/                     # SPIFFS用ファイル
│   ├── index.html            # WebUI HTMLファイル
│   └── style.css             # WebUI CSSファイル（将来追加予定）
├── include/
├── lib/
├── test/
├── platformio.ini            # PlatformIO設定
├── README.md                 # このファイル
└── .gitignore                # Git除外設定
```

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. ディスプレイにノイズが表示される

- **原因**: 電源供給不足、信号品質劣化
- **解決方法**:
  - USB 電源の品質を確認
  - ジャンパーワイヤーを短くする
  - 10kΩ プルアップ抵抗を RST ピンに追加

#### 2. WiFi 接続できない

- **原因**: WiFi 認証情報の設定ミス
- **解決方法**:
  - `config.h`の SSID/パスワードを再確認
  - WiFi ルーターの 2.4GHz 帯域を使用（5GHz は ESP32 未対応）
  - セキュリティ設定が WPA2 であることを確認

#### 3. 画像アップロードが失敗する

- **原因**: ファイルサイズまたは形式の問題
- **解決方法**:
  - 画像サイズを 170×320 ピクセル以下に調整
  - ファイルサイズを 512KB 以下に削減
  - JPEG/PNG 形式を使用

#### 4. 一部のディスプレイが表示されない

- **原因**: GPIO20/21 の不安定性（ESP32-C3 特有）
- **解決方法**:
  - GPIO5, GPIO3 に変更を検討
  - 配線の接触不良を確認
  - 電源供給を確認

#### 5. カスタム画像が表示されない

- **原因**: カスタム画像のロード失敗
- **解決方法**:
  - シリアルモニタでデバッグ情報を確認
  - `/api/status`でメモリ状況を確認
  - 「カスタム画像を使用」ボタンを押下

## 🔍 API リファレンス

### WebAPI エンドポイント

| エンドポイント    | メソッド | 説明                 |
| ----------------- | -------- | -------------------- |
| `/`               | GET      | WebUI 表示           |
| `/upload`         | POST     | 画像アップロード     |
| `/api/time`       | GET      | 現在時刻取得         |
| `/api/status`     | GET      | システム状態取得     |
| `/api/reset`      | POST     | デフォルト画像に戻す |
| `/api/use-custom` | POST     | カスタム画像を使用   |
| `/api/refresh`    | POST     | 表示強制更新         |

### ステータス API レスポンス例

```json
{
  "useCustomImages": true,
  "customImages": [
    true,
    false,
    true,
    false,
    false,
    false,
    false,
    false,
    false,
    false
  ],
  "freeHeap": 234567
}
```

## 🎯 今後の拡張予定

### 計画中の機能

- [ ] **アラーム機能**: 指定時刻でのアラート
- [ ] **タイマー機能**: カウントダウンタイマー
- [ ] **色彩調整**: RGB 調整機能
- [ ] **アニメーション**: 数字切り替え時のエフェクト
- [ ] **温度表示**: DS18B20 センサー連携
- [ ] **音楽再生**: DFPlayer Mini 連携

### ハードウェア改良

- [ ] **PCB 設計**: 専用基板の作成
- [ ] **ケース設計**: 3D プリント対応
- [ ] **電源回路**: 外部電源対応
- [ ] **GPIO 変更**: より安定なピン配置

## 🤝 コントリビューション

プロジェクトへの貢献を歓迎します！

1. **Fork**: このリポジトリをフォーク
2. **Feature Branch**: 新機能用のブランチを作成
3. **Commit**: 変更をコミット
4. **Pull Request**: プルリクエストを作成

## 📄 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。

## 📞 サポート

質問や問題がある場合は、GitHub の Issues ページでお知らせください。

---

**楽しいニキシー管ライフを！** 🎉

- **解決**:
  - 各ディスプレイに 100nF バイパスコンデンサを追加
  - ESP32 の電源に 1000μF コンデンサを追加
  - GPIO20, 21 を GPIO5, 3 に変更

#### 2. 一部のディスプレイが動作しない

- **原因**: CS pin の競合、配線ミス
- **解決**:
  - 配線を再確認
  - 各ディスプレイの CS pin が正しく接続されているか確認

#### 3. WiFi 接続エラー

- **原因**: SSID/パスワードの間違い、WiFi 規格非対応
- **解決**:
  - config.h の設定を再確認
  - 2.4GHz WiFi を使用しているか確認

#### 4. 時刻が表示されない

- **原因**: NTP サーバー接続失敗
- **解決**:
  - インターネット接続を確認
  - NTP サーバーアドレスを変更 (`pool.ntp.org`など)

## 📈 カスタマイズ

### 表示順序の変更

`updateClock()` 関数内のディスプレイ割り当てを変更することで、表示順序をカスタマイズできます。

### ニキシー管画像の変更

`image_data.h` ファイル内の画像データを変更することで、異なるデザインのニキシー管を使用できます。

### タイムゾーンの変更

`config.h` の `timeZone` 値を変更することで、任意のタイムゾーンに対応できます。

## 📝 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。

## 🤝 コントリビューション

プルリクエストやイシューの報告を歓迎します。改善提案がございましたら、お気軽にお知らせください。

## 📞 サポート

技術的な質問や問題については、GitHub の Issues ページでお尋ねください。

---

**最終更新**: 2025 年 7 月 23 日
